# Pull Request Build Workflow
# Triggered on pull requests to verify builds and run tests

name: PR Build

on:
  pull_request:
    branches:
      - main
      - master
      - develop
    paths-ignore:
      - '**.md'
      - 'docs/**'
      - '.gitignore'
      - 'LICENSE'

  # Allow manual trigger
  workflow_dispatch:

# Cancel in-progress runs for the same PR
concurrency:
  group: pr-${{ github.event.pull_request.number || github.ref }}
  cancel-in-progress: true

permissions:
  contents: read
  pull-requests: write
  checks: write

jobs:
  # Build and test the plugin
  build:
    name: Build & Test
    uses: ./.github/workflows/build.yml
    with:
      java-version: '21'
      upload-artifact: true
      artifact-name: 'prophunt-pr-${{ github.event.pull_request.number }}'
      run-tests: true

  # Code quality checks
  quality:
    name: Code Quality
    runs-on: ubuntu-latest
    needs: build

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up JDK 21
        uses: actions/setup-java@v4
        with:
          java-version: '21'
          distribution: 'temurin'
          cache: maven

      - name: Check code style (basic)
        run: |
          echo "Checking for common issues..."
          # Check for TODO/FIXME comments
          if grep -rn "TODO\|FIXME" src/main/java --include="*.java"; then
            echo "::warning::Found TODO/FIXME comments in the code"
          fi

      - name: Verify no debug code
        run: |
          # Check for System.out.println (should use logger instead)
          if grep -rn "System.out.println\|System.err.println" src/main/java --include="*.java"; then
            echo "::warning::Found System.out/err.println - consider using logger instead"
          fi

  # Comment on PR with build status
  comment:
    name: PR Comment
    runs-on: ubuntu-latest
    needs: [build, quality]
    if: github.event_name == 'pull_request'

    steps:
      - name: Download artifact
        uses: actions/download-artifact@v4
        with:
          name: prophunt-pr-${{ github.event.pull_request.number }}
          path: ./artifact

      - name: Get artifact info
        id: artifact-info
        run: |
          JAR_FILE=$(ls ./artifact/*.jar 2>/dev/null | head -1)
          if [ -n "$JAR_FILE" ]; then
            SIZE=$(ls -lh "$JAR_FILE" | awk '{print $5}')
            NAME=$(basename "$JAR_FILE")
            echo "jar-name=${NAME}" >> $GITHUB_OUTPUT
            echo "jar-size=${SIZE}" >> $GITHUB_OUTPUT
          fi

      - name: Comment on PR
        uses: actions/github-script@v7
        with:
          script: |
            const jarName = '${{ steps.artifact-info.outputs.jar-name }}' || 'N/A';
            const jarSize = '${{ steps.artifact-info.outputs.jar-size }}' || 'N/A';

            const body = `## Build Summary

            | Status | Details |
            |--------|---------|
            | Build | :white_check_mark: Success |
            | Tests | :white_check_mark: Passed |
            | JAR | \`${jarName}\` (${jarSize}) |

            ### Artifact
            The build artifact is available in the Actions artifacts for this workflow run.

            ---
            *Built with Java 21 on Ubuntu*`;

            // Find existing comment
            const { data: comments } = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
            });

            const botComment = comments.find(comment =>
              comment.user.type === 'Bot' &&
              comment.body.includes('## Build Summary')
            );

            if (botComment) {
              await github.rest.issues.updateComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                comment_id: botComment.id,
                body: body
              });
            } else {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                body: body
              });
            }
